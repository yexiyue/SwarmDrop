---
name: sea-orm-2
description: "SeaORM 2.0 Rust ORM 开发指南。提供 Entity 定义、关系建模（1-1, 1-N, M-N, 自引用）、查询（Entity Loader, Nested Select, Multi Select）、Nested ActiveModel 嵌套操作、Entity First 工作流、Migration 的最佳实践。覆盖 SQLite 和 PostgreSQL。触发场景：编写或修改 sea-orm entity/migration/查询代码，定义数据库关系，使用嵌套增删改，从 1.0 迁移到 2.0，或用户提到 sea-orm、SeaORM、sea_orm、ORM 相关操作。"
---

# SeaORM 2.0 开发指南

SeaORM 2.0 的 Rust ORM 最佳实践，覆盖 Entity 定义、关系建模、查询和嵌套操作。

## 核心模式速查

### Entity 定义（新格式）

```rust
use sea_orm::entity::prelude::*;

#[sea_orm::model]
#[derive(Clone, Debug, PartialEq, Eq, DeriveEntityModel)]
#[sea_orm(table_name = "user")]
pub struct Model {
    #[sea_orm(primary_key)]
    pub id: i32,
    pub name: String,
    #[sea_orm(unique)]
    pub email: String,
    #[sea_orm(has_one)]
    pub profile: HasOne<super::profile::Entity>,
    #[sea_orm(has_many)]
    pub posts: HasMany<super::post::Entity>,
}

impl ActiveModelBehavior for ActiveModel {}
```

### 关系定义速查

| 关系类型 | 正向（父方） | 反向（子方/外键方） |
|----------|-------------|-------------------|
| 1-1 | `#[sea_orm(has_one)]` + `HasOne<E>` | `#[sea_orm(unique)]` 外键 + `#[sea_orm(belongs_to, from="fk", to="pk")]` |
| 1-N | `#[sea_orm(has_many)]` + `HasMany<E>` | 外键（无 unique）+ `belongs_to` |
| M-N | `#[sea_orm(has_many, via = "junction")]` + `HasMany<E>` | junction 表双向 `belongs_to` + 复合主键 |
| 自引用 | `#[sea_orm(self_ref, relation_enum="...", from="fk", to="pk")]` | `relation_reverse` 或 `reverse` |

### 查询（Entity Loader）

```rust
let user = user::Entity::load()
    .filter_by_id(12)
    .with(profile::Entity)                         // 1-1 用 JOIN
    .with((post::Entity, comment::Entity))         // 嵌套用 data loader
    .one(db).await?;
```

### 嵌套操作（ActiveModel Builder）

```rust
let user = user::ActiveModel::builder()
    .set_name("Bob")
    .set_profile(profile::ActiveModel::builder().set_picture("img.jpg"))
    .add_post(post::ActiveModel::builder().set_title("Hello"))
    .save(db).await?;
```

### 强类型列

```rust
user::Entity::find().filter(user::COLUMN.name.contains("Bob"))
// 编译期类型检查，不再需要 CamelCase 枚举
```

## 详细参考文档

按需查阅以下 references 文件获取完整信息：

- **[entity-format.md](references/entity-format.md)** — 新 Entity 格式详解、`#[sea_orm::model]` 注解、COLUMN 常量、`compact_model` 过渡宏、codegen 命令
- **[relations.md](references/relations.md)** — 所有关系类型（1-1、1-N、M-N、自引用、菱形、Linked）的完整定义方式和代码示例
- **[queries.md](references/queries.md)** — Entity Loader、Model Loader、Nested Select、Multi Select、Relational Query 五种查询方式对比和用法
- **[nested-activemodel.md](references/nested-activemodel.md)** — Nested ActiveModel 嵌套增删改、变更检测、级联删除、幂等性
- **[entity-first.md](references/entity-first.md)** — Entity First 工作流、Schema Sync、自动建表/加列/重命名/索引
- **[migration-guide.md](references/migration-guide.md)** — 1.0 → 2.0 迁移指南、API 破坏性变更、数据库特定变更

## 关键注意事项

- **2.0 新格式仅通过 `#[sea_orm::model]` 启用**，旧格式（手动写 Relation 枚举）仍然有效
- **`compact_model`** 是过渡方案：保留旧 Relation 枚举，但可使用 Entity Loader
- **Entity Loader** 仅适用于 `#[sea_orm::model]` 或 `#[sea_orm::compact_model]`
- **Nested ActiveModel** 仅适用于 `#[sea_orm::model]`（不支持 `compact_model`）
- **junction 表的 belongs_to 字段类型用 `Option<Entity>`**（不是 `HasOne<Entity>`）
- **ExprTrait 必须导入**：`use sea_orm::ExprTrait;`
- **execute → execute_raw**：原始 SQL 用 `execute_raw`，SeaQuery 语句用 `execute`
- **SQLite 限制**：不支持后加外键，不支持 `default_expr`
- **PostgreSQL 变更**：`serial` 默认改为 `GENERATED BY DEFAULT AS IDENTITY`
