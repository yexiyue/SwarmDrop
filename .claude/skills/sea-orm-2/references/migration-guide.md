# SeaORM 1.0 → 2.0 迁移指南

## 目录

- [SeaQuery 类型系统变更](#seaquery-类型系统变更)
- [SeaORM API 变更](#seaorm-api-变更)
- [数据库特定变更](#数据库特定变更)
- [废弃项](#废弃项)

## SeaQuery 类型系统变更

### ExprTrait 必须导入

```rust
// 2.0 必须加：
use sea_orm::ExprTrait;

// 否则 .like(), .eq() 等方法报错
Expr::col("my_col").like("pattern")
```

### IntoCondition 被 Into 替代

```rust
// 旧
.on_condition(|_left, right| Expr::col(..).eq(true).into_condition())

// 新
.on_condition(|_left, right| Expr::col(..).eq(true).into())
```

`ConditionExpression` 已移除，使用 `From/Into` 在 `Condition` 和 `Expr` 之间转换：

```rust
Cond::all().add(Expr::new(..))
```

### Iden trait 签名变更

```rust
// 旧
impl Iden for Glyph {
    fn unquoted(&self, s: &mut dyn fmt::Write) {
        write!(s, "{}", match self { Self::Table => "glyph", .. }).unwrap();
    }
}

// 新
impl Iden for Glyph {
    fn unquoted(&self) -> &str {
        match self { Self::Table => "glyph", .. }
    }
}
```

### Alias 不再必要

```rust
// 旧
Expr::col(Alias::new("my_col"))

// 新 — 直接用字符串
Expr::col("my_col")
```

## SeaORM API 变更

### execute → execute_raw

```rust
// 旧
db.execute(Statement::from_sql_and_values(..)).await?;

// 新
db.execute_raw(Statement::from_sql_and_values(..)).await?;

// 新的 execute 直接接受 SeaQuery 语句，无需手动 build
let query = Entity::find().filter(..).into_query();
let rows = db.query_all(&query).await?;  // 不再需要 backend.build(&query)
```

### insert_many 重构

```rust
// 空迭代器返回 None，不再 panic
let res = Entity::insert_many::<ActiveModel, _>([]).exec(db).await;
assert_eq!(res?.last_insert_id, None);

// 有数据时返回 Some
let res = Entity::insert_many([..]).exec(db).await;
assert_eq!(res?.last_insert_id, Some(2));

// exec_with_returning 现在返回 Vec<Model>
// exec_with_returning_many 已废弃，改用 exec_with_returning
```

### DeriveValueType 增强

自动实现 `NotU8`, `IntoActiveValue`, `TryFromU64`。自定义包装类型可用作主键：

```rust
#[derive(Clone, Debug, PartialEq, Eq, DeriveValueType)]
pub struct MyInteger(pub i32);

pub struct Model {
    #[sea_orm(primary_key)]
    pub id: MyInteger,  // 现在可以了
}
```

### delete_by_* 返回类型变更

```rust
// 旧：返回 DeleteMany
fn delete_by_id<T>(values: T) -> DeleteMany<Self>

// 新：返回 ValidatedDeleteOne
fn delete_by_id<T>(values: T) -> ValidatedDeleteOne<Self>

// exec_with_returning 返回 Option<Model> 而非 Vec<Model>
```

## 数据库特定变更

### PostgreSQL

`serial` 被 `GENERATED BY DEFAULT AS IDENTITY` 替代：

```sql
-- 新默认行为
CREATE TABLE "character" (
    "id" integer GENERATED BY DEFAULT AS IDENTITY NOT NULL PRIMARY KEY
)
```

恢复旧行为：启用 `option-postgres-use-serial` feature flag。

### SQLite

- `Integer` 和 `BigInteger` 都映射为 `integer`，entity generator 默认用 `i64`
- 用 `--big-integer-type=i32` 指定使用 `i32`
- `sqlite-use-returning-for-3_35` 默认启用

### MariaDB

新增 `mariadb-use-returning` feature 支持 RETURNING 语法。

## 废弃项

| 项目 | 变更 |
|------|------|
| Rust 版本 | 2024 edition, MSRV 1.85 |
| async-std | 已废弃，迁移到 tokio |
| `exec_with_returning_many` | 改用 `exec_with_returning` |
| `ConditionExpression` | 已移除，用 `From/Into` |
| `IntoCondition` | 改用 `.into()` |

## 迁移检查清单

1. [ ] 升级 `sea-orm` 和 `sea-query` 依赖到 2.0
2. [ ] 添加 `use sea_orm::ExprTrait;` 到使用 Expr 方法的文件
3. [ ] `.into_condition()` → `.into()`
4. [ ] `db.execute(Statement::...)` → `db.execute_raw(Statement::...)`
5. [ ] `Alias::new("x")` → `"x"`（可选优化）
6. [ ] 检查 `insert_many` 的返回值处理
7. [ ] 如果手动实现了 `Iden`，更新 `unquoted` 签名
8. [ ] 确认 Rust 版本 ≥ 1.85
9. [ ] 如使用 async-std，迁移到 tokio
10. [ ] PostgreSQL：确认 `GENERATED BY DEFAULT AS IDENTITY` 兼容
