# SwarmDrop 产品需求文档

## 产品定位

SwarmDrop 是一款**去中心化、跨网络、端到端加密**的文件传输工具。

定位为"**跨网络版的 LocalSend**"：无需账号、无需服务器、支持局域网和跨网络传输，文件直接在设备间点对点传输。

### Slogan

> "Drop files anywhere. No cloud. No limits."

### 目标用户

1. **隐私敏感用户**：不想文件经过任何第三方服务器
2. **跨生态用户**：同时使用 Windows/macOS/Linux/Android/iOS
3. **异地协作者**：需要与不同城市的朋友/同事快速传文件
4. **技术爱好者**：喜欢开源，愿意自托管

### 核心差异化

| 维度 | LocalSend | Send Anywhere | SwarmDrop |
|------|-----------|---------------|-----------|
| 网络范围 | 仅局域网 | 跨网络 | 跨网络 |
| 服务器依赖 | 无 | 有中转服务器 | 无（可选自建引导节点） |
| 开源 | 是 | 否 | 是 |
| 隐私 | 本地传输 | 可能经服务器 | 端到端加密 |
| 自托管 | 不需要 | 不支持 | 支持自建引导节点 |

---

## 功能清单

### P0：核心功能（MVP 必须）

#### 1. 发送文件

- 选择文件/文件夹 → 生成分享码
- 分享码格式：6 位字母数字（如 `AB12CD`）
- 分享码有效期：10 分钟（可配置）
- 支持多文件/文件夹一次性发送
- 等待接收方连接，显示连接状态

#### 2. 接收文件

- 输入分享码 → 连接发送方
- 显示文件列表（文件名、大小、数量）
- 确认接收 → 开始传输
- 选择保存位置
- 传输完成通知

#### 3. 局域网发现（mDNS）

- 自动发现同一局域网内的 SwarmDrop 设备
- 显示附近设备列表
- 点击设备直接发送（无需分享码）
- 可拒绝被发现（隐身模式）

#### 4. 跨网络传输

- 通过 DHT 发现分享码对应的发送方
- NAT 穿透（DCUtR 打洞）
- Relay 中继兜底（打洞失败时）
- 连接引导节点加入 DHT 网络

#### 5. 端到端加密

- 每次传输生成临时密钥对
- 文件内容 XChaCha20-Poly1305 加密
- 分享码中包含加密密钥（或密钥协商信息）
- 中继节点无法解密文件内容

#### 6. 传输进度

- 实时显示传输进度（百分比 + 速度）
- 大文件分块传输
- 支持取消传输
- 传输完成显示统计（耗时、速度）

#### 7. 设备身份

- 本地生成密钥对作为设备标识
- 设置设备名称（如"张三的 MacBook"）
- 设备指纹显示（用于验证）

### P1：重要功能（MVP 后优先）

#### 8. 历史记录

- 发送/接收历史列表
- 显示：时间、对方设备名、文件列表、状态
- 可清除历史记录

#### 9. 收藏设备

- 将常用设备加入收藏
- 收藏设备可直接发送，无需分享码
- 收藏设备自动信任

#### 10. 断点续传

- 大文件传输中断后可恢复
- 记录已传输的分块
- 重新连接后从断点继续

#### 11. 批量操作

- 拖拽多个文件/文件夹
- 压缩发送（可选）
- 文件夹保持目录结构

#### 12. MCP 服务（AI 集成）

**场景**：AI 助手（如 Claude Code）可以直接调用 SwarmDrop 发送内容到其他设备

**前置条件**：
- SwarmDrop 后台进程运行中（系统托盘）
- MCP Server 监听 `localhost:19527`

**MCP Tools**：

| Tool | 参数 | 功能 |
|------|------|------|
| `list_nearby_devices` | - | 列出 mDNS 发现的附近设备 |
| `list_favorite_devices` | - | 列出收藏的设备 |
| `send_text` | `device_id`, `content`, `filename?` | 发送文本内容到设备 |
| `send_file` | `device_id`, `file_path` | 发送本地文件到设备 |
| `create_share_code` | `content` 或 `file_path` | 生成分享码供远程设备接收 |
| `get_transfer_status` | `transfer_id` | 查询传输状态 |

**后台进程**：
- 应用关闭后保持托盘运行（系统托盘图标）
- 开机自启动（可选配置）
- 托盘菜单：显示主窗口 / 暂停服务 / 退出

**安全考虑**：
- 仅监听 localhost，拒绝外部连接
- 首次连接需用户在 UI 确认授权
- 可配置允许的 MCP 客户端列表

**用户流程示例**：
```
1. 用户对 AI 说："把这段代码发到我手机上"
2. AI 调用 list_nearby_devices 找到手机
3. AI 调用 send_text 发送内容
4. SwarmDrop 托盘弹出通知："已发送到 [iPhone]"
```

### P2：后续迭代

#### 13. 移动端

- Android / iOS 客户端（Tauri 2 移动端）
- 系统分享菜单集成
- 后台传输

#### 14. 剪贴板同步

- 发送剪贴板内容（文本、图片）
- 快捷键触发

#### 15. 接收确认

- 发送前需接收方确认
- 可设置自动接收（信任设备）

#### 16. 传输限速

- 限制上传/下载速度
- 避免占满带宽

---

## 技术架构

```
┌──────────────────────────────────────┐
│           React 前端                  │
│                                      │
│  文件选择 / 分享码输入 / 进度显示      │
│    ↕                                 │
│  Tauri invoke / events               │
└──────────┬───────────────────────────┘
           │ IPC
┌──────────▼───────────────────────────┐
│        Tauri Rust 后端                │
│                                      │
│  文件读写 / 分块 / 校验                │
│  E2E 加密层 (XChaCha20-Poly1305)     │
│    ↕                                 │
│  libp2p Swarm                        │
│    ├─ Request-Response (文件传输)    │
│    ├─ mDNS (局域网发现)              │
│    ├─ Kademlia DHT (跨网络发现)      │
│    ├─ Relay (NAT 穿透兜底)           │
│    └─ DCUtR (NAT 打洞)               │
│    ↕                                 │
│  SQLite (历史记录 + 设备信息)         │
└──────────────────────────────────────┘
```

### 技术选型

| 层面 | 选型 | 说明 |
|------|------|------|
| 应用框架 | Tauri v2 | 跨平台桌面，后续支持移动端 |
| 前端框架 | React + TypeScript | |
| UI 组件 | shadcn/ui + Tailwind CSS | |
| P2P 网络 | libp2p | Request-Response + mDNS + DHT + Relay |
| 加密 | XChaCha20-Poly1305 | 24 字节 nonce，纯 Rust 实现 |
| 持久化 | SQLite (rusqlite) | 轻量，仅存历史记录 |

### 与 SwarmNote 的关系

SwarmDrop 复用 SwarmNote Phase 1 的 P2P 网络层核心：

```
swarm-apps/                    # Monorepo
├── crates/
│   └── swarm-p2p/             # 共享 P2P 库
│       ├── transport.rs       # TCP + Noise + Yamux
│       ├── discovery.rs       # mDNS + DHT
│       ├── relay.rs           # NAT 穿透
│       └── protocol.rs        # Request-Response
├── apps/
│   ├── swarmdrop/             # 快传工具
│   └── swarmnote/             # 笔记应用（后续）
└── bootstrap/                 # 引导节点程序
```

---

## 平台支持

### MVP 阶段

- Windows 10/11
- macOS 12+
- Linux (Ubuntu 22.04+, Fedora 38+)

### 后续

- Android 10+
- iOS 15+

---

## 用户流程

### 发送文件

```
1. 打开 SwarmDrop
2. 拖拽文件到窗口（或点击选择）
3. 点击"发送"
4. 显示分享码：AB12CD
5. 将分享码告诉接收方（微信/短信/口头）
6. 等待接收方连接...
7. 显示"已连接 [张三的 iPhone]"
8. 传输中... 45% (2.3 MB/s)
9. 传输完成！
```

### 接收文件

```
1. 打开 SwarmDrop
2. 输入分享码：AB12CD
3. 连接中...
4. 显示文件列表：
   - photo.jpg (2.1 MB)
   - video.mp4 (128 MB)
   共 2 个文件，130.1 MB
5. 点击"接收"
6. 选择保存位置
7. 传输中... 45% (2.3 MB/s)
8. 传输完成！[打开文件夹]
```

### 局域网快传

```
1. 打开 SwarmDrop
2. 看到附近设备：
   - 张三的 iPhone
   - 李四的 MacBook
3. 拖拽文件到"张三的 iPhone"
4. 对方收到请求弹窗
5. 对方确认接收
6. 直接传输（无需分享码）
```

---

## 界面设计

### 主界面

```
┌─────────────────────────────────────────────────┐
│  SwarmDrop                              ⚙ 设置  │
├─────────────────────────────────────────────────┤
│                                                 │
│         ┌─────────────────────────┐             │
│         │                         │             │
│         │    拖拽文件到这里        │             │
│         │       或点击选择         │             │
│         │                         │             │
│         └─────────────────────────┘             │
│                                                 │
│  ─────────────── 或 ───────────────             │
│                                                 │
│         输入分享码  [______] [接收]             │
│                                                 │
├─────────────────────────────────────────────────┤
│  附近设备                                        │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐        │
│  │ 📱       │ │ 💻       │ │ 🖥        │        │
│  │ iPhone   │ │ MacBook  │ │ Desktop  │        │
│  └──────────┘ └──────────┘ └──────────┘        │
├─────────────────────────────────────────────────┤
│  🟢 在线 | 本机：我的电脑 (A1B2:C3D4)            │
└─────────────────────────────────────────────────┘
```

### 发送等待界面

```
┌─────────────────────────────────────────────────┐
│  SwarmDrop                              ✕ 取消  │
├─────────────────────────────────────────────────┤
│                                                 │
│                  分享码                          │
│                                                 │
│              ┌─────────────┐                    │
│              │   AB12CD    │   [复制]           │
│              └─────────────┘                    │
│                                                 │
│           有效期：9:42 剩余                      │
│                                                 │
│  ─────────────────────────────────────          │
│                                                 │
│  待发送文件：                                    │
│  📄 document.pdf        2.1 MB                  │
│  🖼 photo.jpg           856 KB                  │
│  📁 project/            12.3 MB                 │
│                                                 │
│  共 3 项，15.2 MB                               │
│                                                 │
│  等待接收方连接...                               │
│                                                 │
└─────────────────────────────────────────────────┘
```

### 传输进度界面

```
┌─────────────────────────────────────────────────┐
│  SwarmDrop                              ✕ 取消  │
├─────────────────────────────────────────────────┤
│                                                 │
│  正在发送到：张三的 iPhone                       │
│                                                 │
│  ████████████████░░░░░░░░░  67%                 │
│                                                 │
│  📄 document.pdf        ✓ 完成                  │
│  🖼 photo.jpg           ▶ 传输中 (2.3 MB/s)     │
│  📁 project/            ○ 等待中                │
│                                                 │
│  已传输：10.2 MB / 15.2 MB                      │
│  预计剩余：12 秒                                 │
│                                                 │
└─────────────────────────────────────────────────┘
```

---

## 非功能需求

### 性能

- 局域网传输速度：≥ 50 MB/s（千兆网络）
- 跨网络传输速度：取决于双方带宽，目标 ≥ 5 MB/s
- 分享码生成：< 1 秒
- 连接建立：局域网 < 2 秒，跨网络 < 10 秒
- 支持单文件 10 GB+

### 安全

- 端到端加密，中继节点无法解密
- 分享码仅单次有效
- 传输完成后临时密钥销毁
- 无遥测、无数据上报

### 可靠性

- 大文件分块传输，单块失败可重试
- 网络中断后自动尝试重连
- 传输失败给出明确错误提示

### 易用性

- 零配置即可使用
- 无需注册账号
- 主流程 3 步内完成

---

## 分享码设计

### 格式

```
[A-Z0-9]{6}
例：AB12CD, X7Y8Z9
```

- 6 位字母数字，去除易混淆字符（0/O, 1/I/L）
- 共 32^6 ≈ 10 亿种组合
- 短期有效，冲突概率极低

### 编码内容

```
分享码 → 解码后：
{
  peer_id: "12D3KooW...",        // 发送方 PeerId
  session_id: "uuid",            // 本次传输会话 ID
  encryption_key: [u8; 32],      // 对称加密密钥
  created_at: 1706000000,        // 创建时间戳
}
```

### 发现机制

1. 发送方生成分享码，在 DHT 发布 Provider：
   ```
   PUT_PROVIDER(key=hash(session_id), provider=peer_id)
   ```

2. 接收方输入分享码，在 DHT 查找：
   ```
   GET_PROVIDERS(key=hash(session_id)) → [peer_id]
   ```

3. 连接发送方，开始传输

---

## 开发阶段

### Phase 1：本地可用（2 周）

- Tauri 项目脚手架
- 基础 UI（发送/接收界面）
- 文件选择和读取
- 本地回环测试（同一台机器）

### Phase 2：局域网传输（2 周）

- libp2p Swarm 初始化
- mDNS 局域网发现
- Request-Response 文件传输
- 进度显示

### Phase 3：跨网络传输（2 周）

- Kademlia DHT
- NAT 穿透（Relay + DCUtR）
- 引导节点部署
- 分享码机制

### Phase 4：安全与体验（1 周）

- E2E 加密
- 历史记录
- 错误处理优化
- UI 打磨

### Phase 5：发布准备（1 周）

- 打包和签名
- 官网和文档
- GitHub Release

---

## 风险与对策

| 风险 | 对策 |
|------|------|
| NAT 穿透成功率低 | Relay 兜底，多引导节点 |
| 大文件传输不稳定 | 分块 + 重试 + 校验 |
| 跨网络连接慢 | DHT 预热，缓存发现结果 |
| 与 LocalSend 竞争 | 差异化于跨网络能力 |

---

## 成功指标

### MVP 验收标准

- [ ] 两台局域网设备可互传 100MB 文件
- [ ] 两台跨网络设备（不同城市）可互传 100MB 文件
- [ ] 传输速度：局域网 ≥ 30 MB/s，跨网络 ≥ 1 MB/s
- [ ] 端到端流程 < 1 分钟完成

### 长期目标

- GitHub Stars: 1000+（6 个月）
- 日活用户: 1000+（1 年）
- 支持平台: 5 个（Windows/macOS/Linux/Android/iOS）
